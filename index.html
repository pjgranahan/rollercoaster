<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Bitcoin Roller Coaster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

<div data-role="page" id="mainPage">

    <div data-role="header" data-theme="e">
        <h1>Bitcoin Roller Coaster</h1>
    </div>

    <div data-role="main" class="ui-content">
        <div id="chartContainer" style="height: 400px; width: 100%;">
        </div>

        <div id="texts" class="ui-content">
            <p style="text-align:center">
                <font color="gray"><i>You own: </i></font>
                    <font color="green"><strong id="dollars" color="">10000.00 USD</strong></font>
                    <font color="orange"><i id="bitcoins">100.00 BTC</i></font>
            </p>

            <p style="text-align:center">
                <font color="green" id="timeLeft">1000</font> minutes left to trade!
            </p>
        </div>

        <button id="start" data-theme="c">HOP ON - BUY</button>
        <button id="stop" data-theme="b">GET OFF - SELL</button>

        <!--<form class="full-width-slider" id="sliderParent">-->
            <!--<label for="speedSlider" class="ui-hidden-accessible">Speed:</label>-->
            <!--<input type="range" id="speedSlider" data-track-theme="a" data-theme="a" min="1" max="75" value="1">-->
        <!--</form>-->

        <!-- "Popup" intro page - must be on the same page to work in the popup context -->
        <div id="introPage" data-role="popup" data-inline="true" data-position-to="window" data-corners="true"
             data-shadow="true" data-iconshadow="true" class="ui-content" data-transition="slidedown"
             data-dismissible="false">

            <!--<div data-role="header" data-theme="e">-->
                <!--<h1>Welcome to the Bitcoin Roller Coaster!</h1>-->
            <!--</div>-->
            <!-- /header -->

            <div data-role="content" data-theme="d">
                <p style="text-align:center">
                    Do you need more Bitcoin volatility in your life?
                </p>
                <p style="text-align:center" >
                    Crave all the thrilling losses of day-trading, with none of reward?
                </p>
                <p style="text-align:center">
                    The Bitcoin Roller Coaster is for you!
                </p>
                <p style="text-align:center">
                    <img src="images/bitcoin-roller-coaster.gif" alt="To the moon!!! ┗(°0°)┛" height="100px" width="100px" >
                </p>

                <!--<a href="" data-rel="button" data-role="button" data-inline="false" id="introCloseButton">I want to take a ride!</a>-->
                <button data-inline="false" id="introCloseButton">I want to take a ride!</button>
            </div>
            <!-- /content -->
        </div>

        <!-- "Popup" profit page - must be on the same page to work in the popup context -->
        <div id="profitPage" data-role="popup" data-inline="true" data-position-to="window" data-corners="true"
             data-shadow="true" data-iconshadow="true" class="ui-content" data-transition="slidedown"
             data-dismissible="false">

            <div data-role="header" data-theme="e">
                <h1>Profits!</h1>
            </div>
            <!-- /header -->

            <div data-role="content" data-theme="d">
                <p style="text-align:center" id="profit_container">
                    <font color="black" id="profit">0 BTC</font>
                </p>
                <!--<a href="" data-rel="back" data-role="button" data-inline="false" data-icon="back" id="profitCloseButton">I want to ride again!</a>-->
                <button data-inline="false" data-icon="back" id="profitCloseButton">I want to ride again!</button>
            </div>
            <!-- /content -->
        </div>

    </div>
</div>


<link rel="stylesheet" href="assets/jquery-mobile/jquery.mobile-1.4.2.css">
<link rel="stylesheet" href="assets/rollercoaster.css">
<!-- order matters - this css overwrites the previous one -->
<script src="assets/jquery-1.10.2.min.js"></script>
<script src="assets/jquery-mobile/jquery.mobile-1.4.2.min.js"></script>
<script src="assets/canvasjs-1.5.1/canvasjs.min.js"></script>
<!-- <script src="assets/jquery-2.1.1.min.js"></script> -->


<script type="text/javascript">

window.onload = function () {

    var data; // array of dataPoints
    var xVal; // the x coordinate that datapoints will begin at
    var yVal; // the y coordinate that datapoints will begin at
    var updateInterval; // how frequently the chart will be updated (in milliseconds)
    var dataLength; // number of dataPoints visible at any point
    var pointColor; // the color of dataPoints on the chart
    var markerSize; // the size of dataPoints on the chart
    var gameTicks; //number of ticks the game should be played for, equivalent to game duration

    var bitcoins; // Capital in BTC
    var dollars; // Capital in USD
    var usd_per_btc; // How many USD will 1 BTC cost
    var btc_per_usd; // How many BTC will 1 USD cost

    var chart; // the CanvasJS chart

    var introPage = $("#introPage");
    var profitPage = $("#profitPage");
    introPage.popup({ history: false });
    profitPage.popup({ history: false });
    $.mobile.popup.prototype.options.history = false;

    CanvasJS.addColorSet("bitcoin_colors",
            [//colorSet Array
                "#FF9900"
            ]);

    function updateChart(count) {
        count = count || 1; // count is number of times loop runs to generate random dataPoints.

        var randomNum;
        for (var j = 0; j < count; j++) {
            randomNum = Math.round((Math.random() * 10) - 5);
            yVal = Math.max(yVal + randomNum, 0);
            data.push({
                x: xVal,
                y: yVal,
                color: pointColor,
                markerSize: markerSize
            });
            xVal++;
        }
        if (data.length > dataLength) {
            data.shift();
        }

        chart.render();

        pointColor = 'orange';
        markerSize = 1;
    }


    function exchangeWorth(amount, exchange_rate) {
        return amount * exchange_rate;
    }

    function updateHoldings() {
        if (bitcoins == 0) {
            bitcoins = dollars / usd_per_btc;
            dollars = 0;
        } else if (dollars == 0) {
            dollars = bitcoins * usd_per_btc;
            bitcoins = 0;
        }

        // $("#bitcoins").text(dps[dps.length-1].y)
        $("#bitcoins").text(bitcoins.toFixed(2) + " BTC");
        $("#dollars").text(dollars.toFixed(2) + " USD");
    }


    // Color conversions
    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }


    // Animations
    function animate(timeLeft) {
        updateChart();

        usd_per_btc = Math.max(data[data.length - 1].y, 0.0001); // dirty dirty hack to avoid infinity values
        btc_per_usd = 1 / usd_per_btc;


        var timeLeftColor = rgbToHex(255 * (1000 - timeLeft) / 1000, 255 * timeLeft / 1000, 0);
        var timeLeftSelector = $("#timeLeft");
        timeLeftSelector.text(timeLeft);
        timeLeftSelector.css('color', timeLeftColor);

        var chartContainer = $("#chartContainer");

        if (timeLeft > 0) {
            setTimeout(function () {
                animate(timeLeft - 1);
            }, updateInterval);
        } else {
            $("#profit").text((dollars + exchangeWorth(bitcoins, usd_per_btc) - 10000) + " USD"); //update profit
            profitPage.popup(); // inits the popup
            profitPage.popup("open"); // opens the popup
        }


    }

    $("#start").on("click", function () {
        pointColor = 'green';
        markerSize = 6;
        updateHoldings();
        $("#start").toggle();
        $("#stop").toggle();
        $("#dollars").toggle();
        $("#bitcoins").toggle();
    });

    $("#stop").on("click", function () {
        pointColor = 'red';
        markerSize = 6;
        updateHoldings();
        $("#start").toggle();
        $("#stop").toggle();
        $("#dollars").toggle();
        $("#bitcoins").toggle();
    });

    $("#introCloseButton").on("click", function () {
        introPage.popup("close");
        introPage.popup("close");
    });
    $("#profitCloseButton").on("click", function () {
        profitPage.popup("close");
//        profitPage.popup("close");
    });



    introPage.bind({
        popupafterclose: function (event, ui) {
            resetGame([], 300, 0, 100, 100, 200, 'orange', 2, 0, 10000, 100);
            startGame(gameTicks);
        }
    });
    profitPage.bind({
        popupafterclose: function (event, ui) {
            resetGame([], 300, 0, 100, 100, 200, 'orange', 2, 0, 10000, 100);
            startGame(gameTicks);
        }
    });


    function startGame(numTicks) {
        updateChart(dataLength);
        animate(numTicks);
    }

    function resetGame(dataParam, gameTicksParam, xValParam, yValParam, updateIntervalParam, dataLengthParam,
                       colorParam, markerSizeParam, bitcoinsParam, dollarsParam, usd_to_btcParam) {

        data = dataParam;
        gameTicks = gameTicksParam;
        xVal = xValParam;
        yVal = yValParam;
        updateInterval = updateIntervalParam;
        dataLength = dataLengthParam;
        pointColor = colorParam;
        markerSize = markerSizeParam;
        bitcoins = bitcoinsParam;
        dollars = dollarsParam;
        usd_per_btc = usd_to_btcParam;
        btc_per_usd = 1 / usd_per_btc;

        chart = new CanvasJS.Chart("chartContainer", {
//        title :{
//           text: "Bitcoin Rollercoaster"
//        },
            creditText: "",
            creditHref: "",
            colorSet: "bitcoin_colors",
            data: [
                {
                    type: "spline",
                    dataPoints: data,
                    toolTipContent: "${y}",
                    lineThickness: 2,
                    markerSize: 2
                }
            ],
            toolTip: {
                animationEnabled: false
            },
            axisX: {
                // title: "Minutes",
                // gridThickness: 1,
                tickLength: 5,
                // prefix: "test"
                interval: 100,
                prefix: "minute "
            },
            axisY: {
                interlacedColor: "#F8F1E4",
                tickLength: 5,
                prefix: "$",
                gridThickness: 0
            }
        });


        $("#stop").hide();
        $("#bitcoins").hide();
        $("#start").show();
        $("#dollars").show();
    }

    introPage.popup(); //inits the popup
    introPage.popup("open"); //opens the popup

    resetGame([], 300, 0, 100, 100, 200, 'orange', 2, 0, 10000, 100);
    updateChart(dataLength);
}
</script>

</body>
</html>
